name: Docker Compose Validation

on:
  push:
    branches: [ main, master ]
    paths:
      - 'docker-compose.yml'
      - '*.env.example'
      - 'scripts/**'
      - '.github/workflows/docker-compose-validation.yml'
  pull_request:
    paths:
      - 'docker-compose.yml'
      - '*.env.example'
      - 'scripts/**'

jobs:
  validate-compose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create dummy .env file
        run: |
          # Create .env with all required variables from .env.example
          # Use placeholder values for validation
          cat .env.example | grep -v '^#' | grep '=' | sed 's/=.*/=dummy_value/' > .env

          # Add some required secrets with dummy values
          echo "POSTGRES_PASSWORD=dummy_password" >> .env
          echo "REDIS_PASSWORD=dummy_password" >> .env
          echo "SECRET_KEY=dummy_secret_key_for_validation_only" >> .env

      - name: Validate docker-compose.yml syntax
        run: |
          echo "::group::Validating Docker Compose syntax"
          docker compose config > /dev/null
          echo "✓ Docker Compose syntax is valid"
          echo "::endgroup::"

      - name: Check for required environment variables
        run: |
          echo "::group::Validating environment variables"
          if [ -f "scripts/ci/validate-env-vars.sh" ]; then
            chmod +x scripts/ci/validate-env-vars.sh
            ./scripts/ci/validate-env-vars.sh
          else
            echo "⚠️  validate-env-vars.sh not found, skipping"
          fi
          echo "::endgroup::"

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint docker-compose.yml
        run: |
          echo "::group::YAML linting"
          yamllint -c .yamllint.yml docker-compose.yml || true
          echo "✓ YAML linting completed"
          echo "::endgroup::"

      - name: Check for health checks
        run: |
          echo "::group::Validating health checks"
          if [ -f "scripts/ci/validate-healthchecks.sh" ]; then
            chmod +x scripts/ci/validate-healthchecks.sh
            ./scripts/ci/validate-healthchecks.sh
          else
            echo "⚠️  validate-healthchecks.sh not found, skipping"
          fi
          echo "::endgroup::"

      - name: Summary
        if: success()
        run: |
          echo "✅ All validation checks passed!"
          echo ""
          echo "Validated:"
          echo "  - Docker Compose syntax"
          echo "  - Environment variables"
          echo "  - YAML formatting"
          echo "  - Health checks configuration"
